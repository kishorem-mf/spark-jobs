pipelines:
  default:
    - step:
        name: Run tests
        image: timvancann/spark-sbt-ci:2.11-2.1.0
        script:
          - sbt coverage test coverageReport

  branches:
    master:
      - step:
          name: Run tests
          image: timvancann/spark-sbt-ci:2.11-2.1.0
          script:
            - sbt coverage test coverageReport
      - step:
          name: Build assembly artifact
          image: timvancann/spark-sbt-ci:2.11-2.1.0
          script:
          script:
            - sbt -DsparkDependencyType=provided assembly
          artifacts:
            - target/scala-2.11/*.jar
      - step:
          name: Deploy to azure datalake
          image: microsoft/azure-cli
          script:
            - az login --service-principal -u ${AZ_USER_ID} -p ${AZ_PASSWORD} --tenant ${AZ_TENANT_ID}
            - az dls fs upload --account ulohub2dldevne --source-path "target/scala-2.11/*.jar" --destination-path "/deployment/ohub2.0/spark-jobs/spark-jobs.jar"

      - step:
          name: Deploy to gcloud bucket
          image: google/cloud-sdk:latest
          script:
            - echo $G_SECRET > key.json
            - gcloud auth activate-service-account bitbucket@ufs-prod.iam.gserviceaccount.com --key-file=key.json
            - gsutil cp target/scala-2.11/*.jar gs://ufs-prod/deployment/ohub2.0/
