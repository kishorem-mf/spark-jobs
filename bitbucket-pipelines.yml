
pipelines:
  default:
    - step:
        name: Check PEP8 codestyle and run tests
        image: fokkodriesprong/docker-pyspark
        script:
          - conda env create -f environment.yml
          - source activate name-matching
          - pycodestyle --show-source .
          - cd string_matching_package && python -m pytest tests/
    - step:
        name: Test building EGG
        image: timvancann/miniconda3-gcc
        script:
          - conda env create -f environment.yml
          - source activate name-matching
          - ./compile_library.sh
  branches:
    master:
    - step:
        name: Check PEP8 codestyle and run tests
        image: python:3.5.2
        caches:
        script:
          - pip install pytest pycodestyle==2.3.1
#          - pytest tests
          - pycodestyle --show-source .
    - step:
        name: Build EGG
        image: timvancann/miniconda3-gcc
        script:
          - conda env create -f environment.yml
          - source activate name-matching
          - ./compile_library.sh
        artifacts:
          - dist/*.egg
    - step:
        name: Deploy to databricks fs
        image: timvancann/databricks-cli
        deployment: production
        script:
          - touch ~/.databrickscfg
          - echo "[DEFAULT]" >> ~/.databrickscfg
          - echo "host = ${DB_HOST}" >> ~/.databrickscfg
          - echo "token = ${DB_TOKEN}" >> ~/.databrickscfg
          - cat ~/.databrickscfg

          - databricks fs cp --overwrite dist/string_matching.egg dbfs:/libraries/name_matching/string_matching.egg
          - databricks fs cp --overwrite string_matching_package/match_operators.py dbfs:/libraries/name_matching/match_operators.py
          - databricks fs cp --overwrite string_matching_package/match_contacts.py dbfs:/libraries/name_matching/match_contacts.py
          - databricks fs cp --overwrite string_matching_package/join_new_operators_with_persistent_uuid.py dbfs:/libraries/name_matching/join_new_operators_with_persistent_uuid.py

